<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitster LITE (v18 - Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style> /* CSS ESENCIAL (Limpio + Ocultación) */
        :root { --primary-color: #1DB954; --youtube-color: #FF0000; }
        body { background-color: #121212; }
        #player-container { 
            position: relative; width: 100%; height: 80px; 
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7); background-color: #000;
        }
        #iframe-wrapper { position: absolute; width: 100%; height: 400px; top: -310px; left: 0; }
        #iframe-wrapper iframe { width: 100%; height: 100%; border: none; }
        #cover-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.95), rgba(0, 0, 0, 0.98));
            transition: opacity 0.4s ease-in-out; z-index: 10; 
        }
        .cover-hidden { opacity: 0; pointer-events: none; }
    </style>
</head>

<body class="flex justify-center items-start min-h-screen p-4 font-sans text-gray-200">

    <div class="w-full max-w-md mx-auto space-y-6">
        <h1 class="text-4xl font-extrabold text-center text-white pt-4 tracking-tight">HITSTER LITE</h1>
        <p class="text-center text-sm text-gray-400">Escanea o pega enlace, luego Tocar Música.</p>
        <div id="message-box" class="hidden p-3 rounded-xl text-base font-semibold text-center transition-all duration-300"></div>

        <div id="scanner-view">
            <h2 class="text-xl font-semibold mb-3 text-white">Escanea Tarjeta:</h2>
            <div id="reader" class="w-full aspect-square rounded-2xl overflow-hidden shadow-lg bg-gray-900"></div>
            <div class="mt-4 flex gap-2">
                 <input id="urlInput" type="url" placeholder="O pega la URL aquí..." class="flex-grow bg-gray-800 text-white border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
                 <button onclick="loadFromInput()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Cargar</button>
            </div>
            <p class="text-xs text-center text-gray-500 mt-3">Soporta Spotify, YouTube y YouTube Music.</p>
        </div>

        <div id="game-view" class="hidden space-y-6">
            <h2 class="text-xl font-semibold mb-4 text-center text-white">¡Es Hora de Jugar!</h2>
            <div id="player-container">
                 <div id="iframe-wrapper"></div> 
                
                <div id="cover-layer" class="flex flex-col justify-center items-center text-center p-4">
                    <div id="cover-icon" class="text-6xl mb-4" aria-label="Icono">♫</div>
                    <p id="cover-text" class="text-xl font-semibold uppercase tracking-widest text-white mb-10">
                        ¡Escaneo exitoso! <br>Presiona para iniciar.
                    </p>
                    <button onclick="playSong()" id="play-button"
                            class="py-3 px-8 font-bold rounded-full uppercase shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 border-2">
                        TOCAR MÚSICA
                    </button>
                    <button onclick="revealPlayer()" id="reveal-button"
                            class="py-2 px-6 text-sm font-bold rounded-full uppercase shadow-md transition-transform duration-100 ease-in-out transform hover:scale-105 hidden 
                                   bg-red-600 text-white border-2 border-red-800 mt-4">
                        Revelar Pista 
                    </button>
                </div>
            </div>
            <div class="flex justify-center mt-6 space-x-4">
                <button onclick="switchView('scanner')"
                        class="py-3 px-8 font-bold rounded-full uppercase shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105
                               bg-gray-700 text-white hover:bg-gray-600 border-2 border-gray-900">
                    Escanear Nueva Tarjeta
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Variables y Selectores ---
        const qrCodeRegionId = "reader";
        let html5QrcodeScanner = null;
        let isScannerRunning = false;
        let current = { service: null, id: null, kind: null, iframe: null };
        const $ = (sel) => document.querySelector(sel);
        const scannerView = $('#scanner-view'), gameView = $('#game-view');
        const messageBox = $('#message-box'), readerElement = $('#reader');
        const urlInput = $('#urlInput'), playerContainer = $('#player-container');
        const iframeWrapper = $('#iframe-wrapper'), coverLayer = $('#cover-layer');
        const coverIcon = $('#cover-icon'), coverText = $('#cover-text');
        const playButton = $('#play-button'), revealButton = $('#reveal-button');

        // --- Funciones ---
        function displayMessage(message, type = 'info') { /* Sin cambios */ 
            messageBox.textContent = message; messageBox.classList.remove('hidden', 'bg-red-700', 'bg-green-700', 'bg-blue-500');
            if (!message) { messageBox.classList.add('hidden'); return; } messageBox.classList.remove('hidden'); 
            if (type === 'error') { messageBox.classList.add('bg-red-700'); setTimeout(() => messageBox.classList.add('hidden'), 3000); } 
            else if (type === 'success') { messageBox.classList.add('bg-green-700'); } else if (type === 'youtube') { messageBox.classList.add('bg-red-700'); } 
            else { messageBox.classList.add('bg-blue-500'); }
        }
        function switchView(viewName) { /* Sin cambios */ 
            if (viewName === 'scanner') {
                gameView.classList.add('hidden'); scannerView.classList.remove('hidden'); displayMessage(''); 
                current = { service: null, id: null, kind: null, iframe: null }; iframeWrapper.innerHTML = ''; 
                coverLayer.classList.remove('cover-hidden'); playButton.classList.remove('hidden'); 
                revealButton.classList.add('hidden'); revealButton.disabled = false; revealButton.textContent = "Revelar Pista"; 
                coverText.innerHTML = "¡Escaneo exitoso! <br>Presiona para iniciar.";
                playButton.classList.remove('bg-red-600', 'border-red-800'); playButton.classList.add('bg-green-500', 'border-green-700', 'text-white');
                coverIcon.style.color = "var(--primary-color)"; coverIcon.innerHTML = '♫';
                urlInput.value = ''; startScanner(); 
            } else if (viewName === 'game') {
                scannerView.classList.add('hidden'); gameView.classList.remove('hidden'); stopScanner(); 
                if (current.service === 'youtube' || current.service === 'youtubemusic') {
                    playButton.classList.remove('bg-green-500', 'border-green-700'); playButton.classList.add('bg-red-600', 'border-red-800', 'text-white');
                    coverIcon.style.color = "var(--youtube-color)"; coverIcon.innerHTML = '►'; 
                } else { 
                    playButton.classList.remove('bg-red-600', 'border-red-800'); playButton.classList.add('bg-green-500', 'border-green-700', 'text-white');
                    coverIcon.style.color = "var(--primary-color)"; coverIcon.innerHTML = '♫'; 
                }
                 playButton.classList.remove('hidden'); revealButton.classList.add('hidden'); 
            }
        }
        // --- Lógica Escáner ---
        function onScanSuccess(decodedText, decodedResult) { /* Sin cambios */ 
            stopScanner(); const parsed = parseService(decodedText); 
            if (parsed.service && parsed.id) { current = { ...parsed, iframe: null }; let serviceName = (parsed.service === 'youtube' || parsed.service === 'youtubemusic') ? 'YouTube' : 'Spotify'; displayMessage(`¡QR de ${serviceName} cargado!`, (parsed.service.startsWith('spotify') ? 'success' : 'youtube')); switchView('game'); } 
            else { displayMessage(`QR no válido: ${decodedText}`, "error"); setTimeout(startScanner, 2500); }
        }
        function onScanFailure(error) { /* Silencio */ }
        function startScanner() { /* Sin cambios */ 
             if (!html5QrcodeScanner) { try { html5QrcodeScanner = new Html5Qrcode(qrCodeRegionId); } catch (e) { console.error("Init scanner failed:", e); displayMessage("Error lector QR.", "error"); return; }}
             if (!readerElement || readerElement.offsetParent === null) { console.warn("Reader element not ready."); setTimeout(startScanner, 100); return; }
             if (!isScannerRunning) {
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrcodeScanner.start( { facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => { isScannerRunning = true; console.log("Scanner started."); })
                .catch(err => { console.error("Error starting scanner:", err); let eM = "No se pudo iniciar cámara."; if (err.name === 'NotAllowedError') eM = "Permiso cámara denegado."; else if (err.name === 'NotFoundError') eM = "No se encontró cámara."; else if (err.name === 'NotReadableError') eM = "Cámara en uso."; displayMessage(eM, "error"); isScannerRunning = false; });
            }
        }
        function stopScanner() { /* Sin cambios */ 
             if (html5QrcodeScanner && isScannerRunning) { try { html5QrcodeScanner.stop().then(() => { isScannerRunning = false; console.log("Scanner stopped."); if(readerElement) readerElement.innerHTML = ""; }).catch((err) => { console.warn("Stop scanner error:", err); isScannerRunning = false; if(readerElement) readerElement.innerHTML = ""; }); } catch (e) { console.error("Stop scanner exception:", e); isScannerRunning = false; if(readerElement) readerElement.innerHTML = ""; }} else { isScannerRunning = false; if(readerElement) readerElement.innerHTML = ""; }
        }
        function loadFromInput() { /* Sin cambios */ 
            const url = urlInput.value.trim(); if (!url) { displayMessage("Pega URL.", "error"); return; } const parsed = parseService(url); 
             if (parsed.service && parsed.id) { current = { ...parsed, iframe: null }; let sN = (parsed.service === 'youtube' || parsed.service === 'youtubemusic') ? 'YouTube' : 'Spotify'; displayMessage(`URL ${sN} cargada!`, (parsed.service.startsWith('spotify') ? 'success' : 'youtube')); switchView('game'); } else { displayMessage("URL no válida.", "error"); }
        }
        
        // --- Lógica del Juego ---
        function parseService(url) { /* Sin cambios */ 
             try {
                url = url.trim(); let u = null; try { u = new URL(url); } catch (e) {} const host = u ? u.hostname.replace(/^www\./,'').toLowerCase() : '';
                if (host.includes('youtube.com') || host === 'youtu.be' || host.includes('music.youtube.com')) {
                    let v = null; if (host === 'youtu.be') { v = u.pathname.slice(1).split('/')[0]; } else { v = u.searchParams.get('v'); } if (!v && u.pathname.startsWith('/shorts/')) { v = u.pathname.split('/')[2] || null; } if (!v && u.pathname.startsWith('/embed/')) { v = u.pathname.split('/')[2] || null; } if (v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return { service: host.includes('music.youtube.com') ? 'youtubemusic' : 'youtube', id: v };
                } const spotifyStdMatch = url.match(/https:\/\/open\.spotify\.com\/(?:embed\/)?track\/([a-zA-Z0-9]+)/); if (spotifyStdMatch && spotifyStdMatch[1]) return { service: 'spotify', id: spotifyStdMatch[1], kind: 'track' };
                const spotifyCustomMatch = url.match(/http(s)?:\/\/open\.spotify\.com\/(.+)/); if (spotifyCustomMatch && spotifyCustomMatch[1]) { const pId = spotifyCustomMatch[2].split('/').pop(); if (pId && /^[a-zA-Z0-9]+$/.test(pId) && spotifyCustomMatch[2].includes('track')) { return { service: 'spotify', id: pId, kind: 'track' }; } else { console.log("Matched custom Spotify URL:", url); return { service: 'spotify-custom-embed', id: url, kind: null }; }}
                return { service: null, id: null };
            } catch(e) { console.error("Parse URL Error:", url, e); const sM = url.match(/http(s)?:\/\/open\.spotify\.com\/(.+)/); if (sM && sM[1]) { console.log("Matched custom Spotify URL (catch):", url); return { service: 'spotify-custom-embed', id: url, kind: null }; } return { service: null, id: null }; }
        }
        function buildEmbed({ service, id, kind }) { /* Sin cambios */ 
            let src = '', t = 'R', a = 'autoplay; encrypted-media; fullscreen; picture-in-picture; web-share';
            if (service === 'youtube' || service === 'youtubemusic') { const p = new URLSearchParams({ autoplay: '1', controls: '0', modestbranding: '1', rel: '0', playsinline: '1', enablejsapi: '1' }); try { if (location.origin && location.origin.startsWith('http')) p.set('origin', location.origin); } catch {} src = `https://www.youtube.com/embed/${id}?${p.toString()}`; t = 'YT Player';
            } else if (service === 'spotify') { src = `https://open.spotify.com/embed/$track/${id}?utm_source=generator&theme=0`; t = 'Spotify Player'; a = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture'; 
            } else if (service === 'spotify-custom-embed') { src = id + '?utm_source=generator&theme=0'; t = 'Spotify Player'; a = 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture';
            } else { return null; } 
            const f = document.createElement('iframe'); f.src=src; f.title=t; f.loading='lazy'; f.allow=a; f.allowFullscreen=true; f.style.borderRadius='12px'; return f;
        }

        /**
         * playSong CORREGIDO v18: Envía comando 'playVideo' a YouTube
         */
        function playSong() {
            console.log("playSong called"); // DEBUG
            if (!current.service || !current.id) { displayMessage("No hay pista cargada.", "error"); return; }
            
            const iframe = buildEmbed(current);
            if (!iframe) { displayMessage("Error al crear reproductor.", "error"); return; }
            
            iframeWrapper.innerHTML = ''; 
            iframeWrapper.appendChild(iframe); 
            current.iframe = iframe; // Guardar referencia
            
            // Actualizar UI: Ocultar Play, Mostrar Revelar
            playButton.classList.add('hidden');       
            revealButton.classList.remove('hidden');   
            coverText.innerHTML = "Pista Sonando..."; 
            displayMessage(''); // Limpiar mensaje superior

            // La tapa (#cover-layer) sigue visible por defecto.

            // --- INTENTO DE PLAY EXPLÍCITO ---
            // Darle un pequeño respiro al iframe para cargar antes de enviar comandos
            setTimeout(() => {
                if (!current.iframe) return; // Salir si el usuario escaneó otra cosa mientras esperaba

                if (current.service === 'youtube' || current.service === 'youtubemusic') {
                    console.log("Sending 'playVideo' command to YouTube iframe"); // DEBUG
                    const playMsg = JSON.stringify({ event:'command', func:'playVideo', args:[] });
                    // Usar '?' para evitar error si contentWindow es null (iframe no cargado)
                    current.iframe.contentWindow?.postMessage(playMsg, '*'); 
                } 
                else if (current.service.startsWith('spotify')) {
                     console.log("Focusing Spotify iframe (autoplay might still require interaction)"); // DEBUG
                     // Spotify es menos fiable con autoplay programático
                     current.iframe.focus(); 
                     // Podríamos añadir un mensaje indicando que si no suena, revele y pulse play
                     // displayMessage('Spotify cargado. Si no suena, revela y pulsa play.', 'info');
                }
            }, 500); // Esperar 500ms (medio segundo)
        }

        /**
         * revealPlayer CORREGIDO v18: Ahora sí oculta la tapa
         */
        function revealPlayer() { 
            console.log("revealPlayer called"); // DEBUG
            coverLayer.classList.add('cover-hidden'); // Oculta la tapa
            revealButton.textContent = "¡Revelado!";
            revealButton.disabled = true;
            // Opcional: enfocar el iframe por si el usuario necesita interactuar (Spotify)
             if(current.iframe) current.iframe.focus();
        }

        // --- Inicialización ---
        window.onload = () => { /* Sin cambios */ 
             console.log("Window loaded. Initializing scanner..."); // DEBUG
             try { html5QrcodeScanner = new Html5Qrcode(qrCodeRegionId); switchView('scanner'); } 
             catch (e) { console.error("Init scanner failed:", e); displayMessage("Error lector QR.", "error"); if(scannerView) scannerView.innerHTML = "<p class='text-red-500 text-center'>Escáner no disponible.</p>"; }
        };
    </script>
</body>
</html>