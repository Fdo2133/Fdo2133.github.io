<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hitster LITE v12</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#22c55e; --accent2:#10b981; --danger:#ef4444; --warn:#f59e0b;
    --border:rgba(148,163,184,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#0b1220; color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .app{ width:min(900px,100%); background:var(--panel); border:1px solid var(--border);
        border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  h1{font-size:20px; margin:0}
  .sub{color:var(--muted); margin:4px 0 0}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .panel{background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:12px}
  input[type="url"], input[type="file"]{
    flex:1; min-width:220px; background:#0b1220; color:var(--text);
    border:1px solid var(--border); padding:10px 12px; border-radius:10px; outline:none;
  }
  .btn{
    appearance:none; border:0; cursor:pointer; user-select:none;
    padding:10px 14px; border-radius:10px; font-weight:700; letter-spacing:.2px;
    color:#08140c; background:linear-gradient(180deg,var(--accent),var(--accent2));
  }
  .btn.secondary{ background:#0b1220; color:#cbd5e1; border:1px solid var(--border) }
  .btn.warn{ background:linear-gradient(180deg,var(--warn),#d97706); color:#101010 }
  .btn.danger{ background:linear-gradient(180deg,var(--danger),#b91c1c); color:#fff }
  .pill{ font-size:12px; color:var(--muted) }
  .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
  @media(min-width:880px){ .grid{ grid-template-columns: 1.1fr .9fr } }
  .playerBox{ position:relative; aspect-ratio:16/9; width:100%; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#000 }
  iframe,audio{ width:100%; height:100%; border:0; display:block; background:#000 }
  /* Overlay inicial con botones */
  .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            background:rgba(0,0,0,.5); opacity:0; pointer-events:none; transition:opacity .2s ease }
  .overlay.show{ opacity:1; pointer-events:auto }
  .cta{ background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.2);
        padding:14px; border-radius:12px; text-align:center; max-width:min(95%,520px)}
  /* Cover para ocultar video/caratula mientras suena */
  .cover{ position:absolute; inset:0; background:#0b1220; display:none; align-items:center; justify-content:center;
          border-top:1px solid rgba(255,255,255,.03); border-bottom:1px solid rgba(255,255,255,.03) }
  .cover.show{ display:flex }
  .cover .msg{ color:#cbd5e1; text-align:center; }
  .status{ margin-top:8px; color:var(--muted); font-size:12px }
  /* Scanner */
  .scanner{ display:none; margin-top:8px; }
  .scanner.show{ display:block }
  video#qrVideo{ width:100%; border-radius:10px; border:1px solid var(--border); background:#000 }
</style>
</head>
<body>
<div class="app" role="application" aria-label="Hitster LITE v12">
  <header>
    <h1>Hitster LITE</h1>
    <p class="sub">Escanea el QR o pega el enlace. Luego pulsa <strong>Tocar m√∫sica</strong>.</p>
  </header>

  <div class="grid">
    <!-- Reproductor -->
    <section class="panel" aria-labelledby="sec-player">
      <h2 id="sec-player" style="margin:0 0 8px; font-size:14px; color:#cbd5e1">Reproductor</h2>
      <div id="playerBox" class="playerBox">
        <div id="overlay" class="overlay show" aria-hidden="false">
          <div class="cta">
            <p style="margin:0 0 8px">‚ô´ Escanea o pega la URL. Cuando est√©s listo‚Ä¶</p>
            <div class="row" style="justify-content:center">
              <button id="btnPlay" class="btn" type="button">‚ñ∂Ô∏è Tocar m√∫sica</button>
              <button id="btnReveal" class="btn secondary" type="button">üîé Revelar</button>
              <button id="btnMute" class="btn secondary" type="button">üîá Silencio</button>
            </div>
            <p class="pill" style="margin-top:8px">El audio no iniciar√° sin tu toque (pol√≠tica del navegador).</p>
          </div>
        </div>
        <!-- Cover para ocultar el contenido visual mientras suena -->
        <div id="cover" class="cover">
          <div class="msg">
            <div style="font-weight:700;">Reproduciendo en modo oculto</div>
            <div class="pill">Pulsa ‚ÄúRevelar‚Äù si quieres ver el video/caratula.</div>
          </div>
        </div>
        <!-- Iframe/audio se inyecta din√°micamente -->
      </div>
      <div class="status">Estado: <span id="status">esperando URL‚Ä¶</span></div>
    </section>

    <!-- Entrada + QR -->
    <section class="panel" aria-labelledby="sec-input">
      <h2 id="sec-input" style="margin:0 0 8px; font-size:14px; color:#cbd5e1">Entrada</h2>
      <div class="row">
        <input id="urlInput" type="url" inputmode="url" placeholder="Pega enlace de YouTube / YouTube Music / Spotify‚Ä¶" aria-label="URL de la canci√≥n" />
        <button id="btnLoad" class="btn" type="button">Cargar</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnScan" class="btn secondary" type="button">üì∑ Escanear QR</button>
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
        <button id="btnStopScan" class="btn secondary" type="button">‚èπÔ∏è Detener</button>
        <span class="pill">Tip: tambi√©n puedes abrir <code>?u=URL</code> desde el QR.</span>
      </div>

      <!-- Bloque del esc√°ner -->
      <div id="scanner" class="scanner">
        <video id="qrVideo" playsinline muted></video>
        <div class="row" style="margin-top:6px">
          <span class="pill" id="scanStatus">Preparando c√°mara‚Ä¶</span>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  // ======= Utilidades / Estado =======
  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const playerBox = $('#playerBox');
  const overlay = $('#overlay');
  const cover = $('#cover');
  const urlInput = $('#urlInput');
  const btnLoad = $('#btnLoad');
  const btnPlay = $('#btnPlay');
  const btnReveal = $('#btnReveal');
  const btnMute = $('#btnMute');
  const btnScan = $('#btnScan');
  const btnStopScan = $('#btnStopScan');
  const fileInput = $('#fileInput');
  const scannerWrap = $('#scanner');
  const qrVideo = $('#qrVideo');
  const scanStatus = $('#scanStatus');

  let current = {
    service: null, id: null, kind: null,
    muted: false, ready: false, iframe: null,
    concealed: true
  };

  let scanStream = null;
  let scanLoop = null;
  let barcodeDetector = null;

  const setStatus = (t) => statusEl.textContent = t;

  // ======= Detecci√≥n de servicio =======
  function parseService(url) {
    try {
      const u = new URL(url);
      const host = u.hostname.replace(/^www\./,'').toLowerCase();

      if (host.includes('youtube.com') || host === 'youtu.be' || host.includes('music.youtube.com')) {
        let videoId = null;
        if (host === 'youtu.be') {
          videoId = u.pathname.slice(1);
        } else {
          videoId = u.searchParams.get('v');
          if (!videoId && u.pathname.startsWith('/shorts/')) {
            videoId = u.pathname.split('/')[2] || null;
          }
        }
        if (videoId) {
          return { service: host.includes('music.youtube.com') ? 'youtubemusic' : 'youtube', id: videoId };
        }
      }

      if (host.includes('spotify.com')) {
        const parts = u.pathname.split('/').filter(Boolean);
        const type = parts[0]; const id = parts[1];
        if ((type === 'track' || type === 'playlist') && id) {
          return { service:'spotify', id, kind:type };
        }
      }
      return { service:null, id:null };
    } catch { return { service:null, id:null } }
  }

  // ======= Construcci√≥n del embed =======
  function buildEmbed({ service, id, kind }) {
    let src = '', title = 'Reproductor', allow = 'autoplay; encrypted-media; clipboard-write; picture-in-picture; web-share';

    if (service === 'youtube' || service === 'youtubemusic') {
      const params = new URLSearchParams({
        autoplay: '0', controls: '1', modestbranding:'1', rel:'0', playsinline:'1', enablejsapi:'1'
      });
      // origin ayuda a la IFrame API; no sirve en file://
      try {
        if (location.origin && location.origin.startsWith('http')) params.set('origin', location.origin);
      } catch {}
      src = `https://www.youtube.com/embed/${id}?${params.toString()}`;
      title = 'YouTube Player';
    } else if (service === 'spotify') {
      const path = (kind === 'playlist') ? 'playlist' : 'track';
      src = `https://open.spotify.com/embed/${path}/${id}?utm_source=generator&theme=0`;
      title = 'Spotify Player';
    }

    if (!src) return null;

    const iframe = document.createElement('iframe');
    iframe.src = src;
    iframe.title = title;
    iframe.loading = 'lazy';
    iframe.allow = allow;
    iframe.allowFullscreen = true;
    iframe.referrerPolicy = 'strict-origin-when-cross-origin';
    return iframe;
  }

  function clearPlayer() {
    playerBox.querySelectorAll('iframe, audio').forEach(n => n.remove());
    current.iframe = null;
  }

  function loadPlayerFrom(url) {
    const { service, id, kind } = parseService(url);
    current.service = service; current.id = id; current.kind = kind || null;
    current.ready = false; current.muted = false;

    clearPlayer();
    if (!service || !id) {
      setStatus('URL inv√°lida o no soportada.');
      overlay.classList.add('show');
      cover.classList.remove('show');
      return;
    }

    const iframe = buildEmbed({ service, id, kind });
    if (!iframe) {
      setStatus('No se pudo crear el reproductor.');
      overlay.classList.add('show');
      cover.classList.remove('show');
      return;
    }

    current.iframe = iframe;
    playerBox.prepend(iframe);

    iframe.addEventListener('load', () => {
      current.ready = true;
      setStatus(`Listo: ${service.toUpperCase()} (${id})`);
      overlay.classList.add('show'); // mantenemos bot√≥n visible hasta tocar
    });

    urlInput.value = url;
  }

  // ======= Reproducir / Mute / Revelar =======
  async function playCurrent(){
    if (!current.iframe) { setStatus('Primero carga una URL.'); return; }
    try {
      overlay.classList.remove('show');
      setStatus('Intentando reproducir‚Ä¶');

      if (current.service === 'youtube' || current.service === 'youtubemusic') {
        // Para maximizar el √©xito, arranca muteado y luego puedes activar sonido.
        const muteMsg = JSON.stringify({ event:'command', func:'mute', args:[] });
        current.iframe.contentWindow.postMessage(muteMsg, '*');
        const playMsg = JSON.stringify({ event:'command', func:'playVideo', args:[] });
        current.iframe.contentWindow.postMessage(playMsg, '*');
        current.muted = true;
        btnMute.textContent = 'üîà Con sonido';
        // Modo oculto activo tras Play
        current.concealed = true;
        cover.classList.add('show');
        setStatus('Reproduciendo (YouTube)‚Ä¶');
      } else if (current.service === 'spotify') {
        // Spotify normalmente requiere pulsar Play dentro del embed.
        current.iframe.focus();
        current.concealed = true;
        cover.classList.add('show');
        setStatus('Spotify listo. Si no inicia, pulsa ‚ñ∂ dentro del reproductor.');
      }
    } catch {
      overlay.classList.add('show');
      setStatus('No se pudo iniciar. Vuelve a pulsar Tocar m√∫sica.');
    }
  }

  function toggleMute(){
    if (!current.iframe) return;
    current.muted = !current.muted;
    if (current.service === 'youtube' || current.service === 'youtubemusic') {
      const cmd = current.muted ? 'mute' : 'unMute';
      const msg = JSON.stringify({ event:'command', func:cmd, args:[] });
      current.iframe.contentWindow.postMessage(msg, '*');
    }
    btnMute.textContent = current.muted ? 'üîà Con sonido' : 'üîá Silencio';
  }

  function reveal(){
    current.concealed = false;
    cover.classList.remove('show');
    setStatus('Contenido revelado.');
  }

  // ======= Esc√°ner QR =======
  async function startScan(){
    // Si BarcodeDetector no est√°, usamos fallback de imagen.
    const supported = ('BarcodeDetector' in window);
    if (!supported) {
      scanStatus.textContent = 'Tu navegador no soporta escaneo en vivo. Sube una imagen con el QR.';
      fileInput.click();
      return;
    }

    try {
      const formats = await BarcodeDetector.getSupportedFormats();
      if (!formats.includes('qr_code')) throw new Error('No hay soporte para QR.');
      barcodeDetector = new BarcodeDetector({ formats:['qr_code'] });
    } catch {
      scanStatus.textContent = 'No hay soporte de QR nativo. Sube una imagen con el QR.';
      fileInput.click();
      return;
    }

    // Pedimos c√°mara
    try {
      scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
      qrVideo.srcObject = scanStream;
      await qrVideo.play();

      scannerWrap.classList.add('show');
      scanStatus.textContent = 'Escaneando‚Ä¶ apunta al c√≥digo QR.';

      const detect = async () => {
        if (!barcodeDetector) return;
        try {
          const codes = await barcodeDetector.detect(qrVideo);
          if (codes && codes.length) {
            const value = (codes[0].rawValue || '').trim();
            stopScan();
            if (value) {
              setStatus('QR detectado. Cargando‚Ä¶');
              loadPlayerFrom(value);
            } else {
              setStatus('QR vac√≠o.');
            }
            return; // salimos del bucle
          }
        } catch {}
        scanLoop = requestAnimationFrame(detect);
      };
      scanLoop = requestAnimationFrame(detect);
    } catch (e) {
      scannerWrap.classList.remove('show');
      setStatus('No se pudo acceder a la c√°mara. Revisa permisos del navegador.');
    }
  }

  function stopScan(){
    if (scanLoop) cancelAnimationFrame(scanLoop), scanLoop = null;
    if (qrVideo) { qrVideo.pause(); qrVideo.srcObject = null; }
    if (scanStream) {
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;
    }
    scannerWrap.classList.remove('show');
    scanStatus.textContent = 'Escaneo detenido.';
  }

  // Fallback: analizar imagen subida (solo como puente; no decodifica sin lib extra)
  // Aqu√≠ simplemente usamos la API de navegador para leer texto del nombre si el QR no est√° soportado.
  // Si quieres decodificaci√≥n real de im√°genes, puedo integrar una librer√≠a CDN (html5-qrcode o qr-scanner).
  fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    setStatus('Imagen recibida. (Para decodificaci√≥n real puedo integrar una librer√≠a externa).');
  });

  // ======= Eventos =======
  btnLoad.addEventListener('click', () => {
    const u = urlInput.value.trim();
    if (!u) { setStatus('Pega una URL.'); return; }
    loadPlayerFrom(u);
  });
  btnPlay.addEventListener('click', playCurrent);
  btnReveal.addEventListener('click', reveal);
  btnMute.addEventListener('click', toggleMute);
  btnScan.addEventListener('click', startScan);
  btnStopScan.addEventListener('click', stopScan);

  // Soporte ?u= en la URL
  (function initFromQuery(){
    const q = new URLSearchParams(location.search);
    const u = q.get('u');
    if (u) loadPlayerFrom(u);
    else setStatus('esperando URL‚Ä¶');
  })();
</script>
</body>
</html>
