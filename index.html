<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hitster LITE (v11 - Definitivo)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#22c55e;    /* green-500 */
      --accent-2:#10b981;  /* emerald-500 */
      --danger:#ef4444;    /* red-500 */
      --warning:#f59e0b;   /* amber-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      background: radial-gradient(1200px 800px at 20% 0%, #111827 0%, #0b1220 40%, #05070d 100%), var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:min(960px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
      padding:20px;
    }
    header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .badge{
      font-size:12px; color:#0b1a10; background:linear-gradient(90deg, var(--accent), var(--accent-2));
      padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.4px;
    }
    h1{font-size:28px; margin:6px 0 0}
    .sub{color:var(--muted); margin:0 0 16px; line-height:1.4}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 880px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }
    .panel{
      background:rgba(17,24,39,.6);
      border:1px solid rgba(148,163,184,.2);
      border-radius:16px; padding:16px;
    }
    .panel h2{ margin:0 0 8px; font-size:16px; color:#cbd5e1; letter-spacing:.2px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    input[type="url"]{
      flex:1; min-width:240px;
      background:#0b1220; color:var(--text);
      border:1px solid rgba(148,163,184,.25);
      padding:12px 14px; border-radius:12px; outline:none;
    }
    input[type="url"]::placeholder{ color:#64748b }
    .btn{
      appearance:none; border:0; cursor:pointer; user-select:none;
      padding:12px 16px; border-radius:12px; font-weight:700; letter-spacing:.3px;
      color:#08140c; background:linear-gradient(180deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(16,185,129,.35);
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      transition:transform .05s ease, filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.05) }
    .btn:active{ transform:translateY(1px) }
    .btn.secondary{
      color:#cbd5e1; background:#0b1220; border:1px solid rgba(148,163,184,.35);
      box-shadow:none;
    }
    .btn.warn{ background:linear-gradient(180deg, var(--warning), #d97706); color:#0b0b0b }
    .btn.danger{ background:linear-gradient(180deg, var(--danger), #b91c1c); color:#fff }
    .pill{ font-size:12px; color:var(--muted) }
    .playerBox{
      position:relative; aspect-ratio:16/9; width:100%; overflow:hidden; border-radius:14px; background:#000;
      border:1px solid rgba(148,163,184,.25);
    }
    iframe, audio{ width:100%; height:100%; display:block; background:#000; border:0 }
    .overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      pointer-events:none; opacity:0; transition:opacity .2s ease;
    }
    .overlay.show{ opacity:1; pointer-events:auto }
    .cta{
      pointer-events:auto;
      display:flex; flex-direction:column; align-items:center; gap:10px; text-align:center;
      background:rgba(0,0,0,.4); border:1px solid rgba(255,255,255,.2);
      padding:16px 18px; border-radius:14px; backdrop-filter: blur(6px);
      max-width:min(92%, 520px)
    }
    .cta h3{ margin:0; font-size:18px }
    .note{ font-size:12px; color:#cbd5e1 }
    .sr{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap }
    .flex-gap{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    footer{ margin-top:16px; color:var(--muted); font-size:12px; text-align:center }
    code.inline{ background:#0b1220; border:1px solid rgba(148,163,184,.25); padding:2px 6px; border-radius:6px }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Hitster LITE">
    <header>
      <span class="badge" aria-hidden="true">HITSTER LITE v11</span>
      <h1>Escanea la Tarjeta Musical y ¬°a jugar!</h1>
    </header>
    <p class="sub">
      Escanea el QR para cargar la canci√≥n (Spotify, YouTube o YouTube Music), luego presiona <strong>Tocar M√∫sica</strong>.
    </p>

    <div class="grid">
      <!-- Columna: Reproductor -->
      <section class="panel" aria-labelledby="sec-player">
        <h2 id="sec-player">Reproductor</h2>
        <div id="playerBox" class="playerBox" aria-live="polite">
          <!-- Aqu√≠ se inyecta el iframe o audio din√°micamente -->
          <div id="overlay" class="overlay show" aria-hidden="false">
            <div class="cta">
              <h3>‚ô´ ¬°Escaneo exitoso!</h3>
              <p class="note">Presiona el bot√≥n para iniciar la reproducci√≥n (requisito del navegador).</p>
              <div class="flex-gap">
                <button id="btnPlay" class="btn" type="button" aria-label="Tocar M√∫sica">‚ñ∂Ô∏è Tocar M√∫sica</button>
                <button id="btnReveal" class="btn secondary" type="button" aria-label="Revelar t√≠tulo y artista">üîé Revelar T√≠tulo y Artista</button>
              </div>
              <div class="flex-gap">
                <button id="btnScanNew" class="btn secondary" type="button">üì∑ Escanear Nueva Tarjeta</button>
                <button id="btnMute" class="btn warn" type="button" aria-pressed="false">üîá Silencio</button>
              </div>
              <p class="pill">Sugerencia: si no se escucha, pulsa <strong>Silencio</strong> para alternar mute.</p>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill">Estado: <span id="status" aria-live="polite">esperando URL‚Ä¶</span></span>
        </div>
      </section>

      <!-- Columna: Entrada / Controles -->
      <section class="panel" aria-labelledby="sec-input">
        <h2 id="sec-input">Escanea o pega la URL</h2>
        <div class="row">
          <input id="urlInput" type="url" inputmode="url" placeholder="Pega aqu√≠ el enlace de YouTube, YouTube Music o Spotify‚Ä¶"
                 aria-label="URL de la canci√≥n" />
          <button id="btnLoad" class="btn" type="button">Cargar</button>
        </div>
        <div style="margin-top:10px" class="row">
          <button id="btnCopyReveal" class="btn secondary" type="button">Copiar T√≠tulo/Artista</button>
          <span class="pill">Tip: el QR deber√≠a abrir la app como <code class="inline">‚Ä¶/index.html?u=URL</code></span>
        </div>

        <div style="margin-top:12px">
          <h2 style="margin:0 0 6px; font-size:14px; color:#cbd5e1">¬°Es Hora de Jugar!</h2>
          <ul style="margin:0 0 0 18px; padding:0; line-height:1.5; color:#cbd5e1">
            <li>Soporta Spotify, YouTube y YouTube Music.</li>
            <li>Bot√≥n <em>Tocar M√∫sica</em> siempre visible para cumplir pol√≠ticas de reproducci√≥n.</li>
            <li>Funciona en m√≥vil y escritorio. Si el audio no inicia, pulsa el bot√≥n nuevamente.</li>
          </ul>
        </div>
      </section>
    </div>

    <footer>
      Hecho por Jose Fernando ¬∑ Modo LITE ¬∑ No afiliado a Spotify / YouTube ‚Äî Solo uso de iframes embebidos.
    </footer>
  </div>

  <script>
    // Utilidades
    const $ = sel => document.querySelector(sel);
    const statusEl = $('#status');
    const playerBox = $('#playerBox');
    const overlay = $('#overlay');
    const urlInput = $('#urlInput');
    const btnLoad = $('#btnLoad');
    const btnPlay = $('#btnPlay');
    const btnReveal = $('#btnReveal');
    const btnScanNew = $('#btnScanNew');
    const btnMute = $('#btnMute');
    const btnCopyReveal = $('#btnCopyReveal');

    let current = {
      service: null,       // 'youtube' | 'spotify' | 'youtubemusic' | null
      id: null,            // videoId | trackId | etc.
      title: null,
      artist: null,
      muted: false,
      ready: false,
      iframe: null
    };

    function setStatus(msg){ statusEl.textContent = msg; }

    // Detecta servicio e ID a partir de una URL
    function parseService(url) {
      try {
        const u = new URL(url);
        const host = u.hostname.replace(/^www\./,'').toLowerCase();

        // YT & YT Music
        if (host.includes('youtube.com') || host.includes('youtu.be') || host.includes('music.youtube.com')) {
          let videoId = null;
          if (host === 'youtu.be') {
            videoId = u.pathname.slice(1);
          } else {
            videoId = u.searchParams.get('v');
            if (!videoId && u.pathname.startsWith('/shorts/')) {
              videoId = u.pathname.split('/')[2] || null;
            }
          }
          if (videoId) {
            return { service: host.includes('music.youtube.com') ? 'youtubemusic' : 'youtube', id: videoId };
          }
        }

        // Spotify (tracks y playlists b√°sicos)
        if (host.includes('spotify.com')) {
          const parts = u.pathname.split('/').filter(Boolean); // ['track','ID'] o ['playlist','ID']
          const type = parts[0];
          const id = parts[1];
          if ((type === 'track' || type === 'playlist') && id) {
            return { service: 'spotify', id, kind: type };
          }
        }

        return { service: null, id: null };
      } catch(e) {
        return { service: null, id: null };
      }
    }

    // Construye iframe embebido
    function buildEmbed({ service, id, kind }) {
      let src = '';
      let title = 'Reproductor';
      let allow = 'autoplay; encrypted-media; clipboard-write; picture-in-picture; web-share';
      let extra = '';

      if (service === 'youtube' || service === 'youtubemusic') {
        // YouTube embed con controles m√≠nimos; mute configurable luego
        const params = new URLSearchParams({
          autoplay: '0',
          controls: '1',
          modestbranding: '1',
          rel: '0',
          playsinline: '1'
        });
        src = `https://www.youtube.com/embed/${id}?${params.toString()}`;
        title = 'YouTube Player';
        extra = 'referrerpolicy="strict-origin-when-cross-origin"';
      }
      else if (service === 'spotify') {
        // Para track y playlist
        const path = kind === 'playlist' ? 'playlist' : 'track';
        src = `https://open.spotify.com/embed/${path}/${id}?utm_source=generator&theme=0`;
        title = 'Spotify Player';
        // Nota: Spotify no permite autoplay program√°tico; el bot√≥n es esencial.
      }

      if (!src) return null;

      const iframe = document.createElement('iframe');
      iframe.setAttribute('src', src);
      iframe.setAttribute('title', title);
      iframe.setAttribute('loading', 'lazy');
      iframe.setAttribute('allow', allow);
      iframe.setAttribute('allowfullscreen', '');
      if (extra) iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');

      return iframe;
    }

    // Carga el reproductor
    function loadPlayerFrom(url) {
      const { service, id, kind } = parseService(url);
      current.service = service;
      current.id = id;
      current.title = null;
      current.artist = null;
      current.ready = false;

      // Limpia el contenedor
      playerBox.querySelectorAll('iframe, audio').forEach(n => n.remove());

      if (!service || !id) {
        setStatus('URL inv√°lida o no soportada.');
        overlay.classList.add('show');
        return;
      }

      const iframe = buildEmbed({ service, id, kind });
      if (!iframe) {
        setStatus('No se pudo crear el reproductor.');
        overlay.classList.add('show');
        return;
      }

      current.iframe = iframe;
      playerBox.prepend(iframe);

      // Cuando el iframe carga, habilitamos el Play
      iframe.addEventListener('load', () => {
        current.ready = true;
        overlay.classList.add('show'); // Mantenemos overlay hasta que el usuario pulse Play
        setStatus(`Listo: ${service.toUpperCase()} (${id})`);
      });

      // Guardamos la URL en el input
      urlInput.value = url;
    }

    // Intenta reproducir (las pol√≠ticas requieren gesto del usuario)
    async function playCurrent(){
      if (!current.iframe) return;
      try {
        // Estrategia:
        //  - Para YouTube: enviamos postMessage para 'playVideo' (API ligera), y como alternativa focusear.
        //  - Para Spotify: enfocamos iframe; el usuario quiz√° deba pulsar Play dentro del embed (limitaci√≥n de Spotify).
        overlay.classList.remove('show');
        setStatus('Intentando reproducir‚Ä¶');

        if (current.service === 'youtube' || current.service === 'youtubemusic') {
          // Usamos la IFrame Player API v√≠a postMessage sin cargar librer√≠a completa.
          const msg = JSON.stringify({ event:'command', func:'playVideo', args:[] });
          current.iframe.contentWindow.postMessage(msg, '*');
          setStatus('Reproduciendo en YouTube‚Ä¶');
        } else if (current.service === 'spotify') {
          // Limitaci√≥n: Spotify requiere interacci√≥n adicional dentro del iframe para iniciar en la mayor√≠a de navegadores.
          current.iframe.focus();
          setStatus('Spotify listo. Si no inicia, pulsa el ‚ñ∂ dentro del reproductor.');
        }
      } catch(e) {
        overlay.classList.add('show');
        setStatus('No se pudo iniciar. Vuelve a pulsar Tocar M√∫sica.');
      }
    }

    function toggleMute(){
      current.muted = !current.muted;
      // Para YouTube podemos usar postMessage 'mute' / 'unMute'
      if (current.iframe && (current.service === 'youtube' || current.service === 'youtubemusic')) {
        const cmd = current.muted ? 'mute' : 'unMute';
        const msg = JSON.stringify({ event:'command', func:cmd, args:[] });
        current.iframe.contentWindow.postMessage(msg, '*');
      }
      btnMute.textContent = current.muted ? 'üîà Con sonido' : 'üîá Silencio';
      btnMute.classList.toggle('warn', !current.muted);
      btnMute.classList.toggle('secondary', current.muted);
    }

    function revealInfo(){
      // Sin APIs de datos externas, mostraremos solo el servicio + ID.
      // (Si deseas, luego integramos oEmbed / Data APIs con clave).
      const info = `Servicio: ${current.service || '‚Äî'}  ¬∑  ID: ${current.id || '‚Äî'}`;
      alert(info);
    }

    function copyReveal(){
      const text = `Servicio: ${current.service || '‚Äî'} | ID: ${current.id || '‚Äî'}`;
      navigator.clipboard.writeText(text).then(() => {
        setStatus('Copiado al portapapeles.');
      });
    }

    function scanNew(){
      urlInput.value = '';
      current = { service:null, id:null, title:null, artist:null, muted:false, ready:false, iframe:null };
      playerBox.querySelectorAll('iframe, audio').forEach(n => n.remove());
      overlay.classList.add('show');
      setStatus('esperando URL‚Ä¶');
      urlInput.focus();
    }

    // Eventos UI
    btnLoad.addEventListener('click', () => {
      const u = urlInput.value.trim();
      if (!u) { setStatus('Pega una URL.'); return; }
      loadPlayerFrom(u);
    });
    btnPlay.addEventListener('click', playCurrent);
    btnReveal.addEventListener('click', revealInfo);
    btnScanNew.addEventListener('click', scanNew);
    btnMute.addEventListener('click', toggleMute);
    btnCopyReveal.addEventListener('click', copyReveal);

    // Si viene ?u= desde el QR, cargamos autom√°ticamente y dejamos el overlay con el bot√≥n visible
    (function initFromQuery(){
      const params = new URLSearchParams(location.search);
      const u = params.get('u');
      if (u) {
        loadPlayerFrom(u);
      } else {
        setStatus('esperando URL‚Ä¶');
        overlay.classList.add('show'); // Mantenemos el bot√≥n visible desde el inicio
      }
    })();
  </script>
</body>
</html>